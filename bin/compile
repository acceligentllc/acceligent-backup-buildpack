#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# clean up leaking environment
unset GIT_DIR

AWS_CLI_URL="https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"

BUILD_DIR=$1
BUILDPACK_DIR="$(dirname $(dirname $0))"
INSTALL_DIR="/app/.awscli"
TMP_DIR=$(mktemp -d)

echo "-----> Downloading AWS CLI"
curl --silent --show-error --fail -o "${TMP_DIR}/awscliv2.zip" "${AWS_CLI_URL}"
unzip -qq -d "${TMP_DIR}" "${TMP_DIR}/awscliv2.zip"

echo "-----> Installing AWS CLI"
mkdir -p "${BUILD_DIR}/.awscli"

if [[ "${BUILD_DIR}" != /app ]]; then
  mkdir -p /app
  ln -nsf "${BUILD_DIR}/.awscli" "${INSTALL_DIR}"
fi

"${TMP_DIR}/aws/install" --install-dir "${INSTALL_DIR}/aws-cli" --bin-dir "${INSTALL_DIR}/bin"
/app/.awscli/bin/aws --version

rm -rf "${TMP_DIR}"

echo "-----> Successfully installed AWS CLI"

if [ ! -d "vendor" ]; then
	mkdir -p vendor
fi

echo "-----> Add backup script to app/vendor"

cp "$BUILDPACK_DIR/backup.sh" $BUILD_DIR/vendor/

echo "-----> backup script moved"
